<!doctype html>
<!--
  Feature-rich single-file Pomodoro Timer
  - Adjustable work/short/long break durations
  - Auto-start next session toggle
  - Session cycles (long break after N pomodoros)
  - Progress ring visualization
  - Start / Pause / Reset / sound test controls
  - Task title input and session history stored in localStorage
  - Desktop notifications and sound alerts
  - Keyboard shortcuts: Space = Start/Pause, R = Reset, T = Toggle Auto-Start
  - Dark / Light toggle
  - Accessible controls and aria labels
-->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Feature-rich Pomodoro Timer</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa7b2;--accent:#f97316;--glass:rgba(255,255,255,0.03)}
    [data-theme="light"]{--bg:#f4f7fb;--card:#ffffff;--muted:#495567;--accent:#ef4444;--glass:rgba(0,0,0,0.03)}
    *{box-sizing:border-box}
    body{font-family:Inter,ui-sans-serif,system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:linear-gradient(180deg,var(--bg),#071025); color:#e6eef6; min-height:100vh; margin:0; display:flex; align-items:center; justify-content:center; padding:28px}
    .wrap{width:980px; max-width:98%; display:grid; grid-template-columns:430px 1fr; gap:20px}
    .card{background:var(--card); border-radius:14px; padding:18px; box-shadow:0 6px 30px rgba(2,6,23,0.6);}
    .header{display:flex; gap:12px; align-items:center; justify-content:space-between}
    h1{font-size:20px;margin:0}
    .muted{color:var(--muted); font-size:13px}
    .controls{display:flex; gap:8px; margin-top:12px}
    button{background:var(--glass); color:inherit; border:1px solid rgba(255,255,255,0.04); padding:10px 12px; border-radius:10px; cursor:pointer}
    button.primary{background:linear-gradient(90deg,var(--accent),#ffb86b); color:#081225; font-weight:600}
    .timer-area{display:flex; align-items:center; gap:18px}
    .ring{width:220px; height:220px; display:grid; place-items:center}
    svg{width:100%; height:100%}
    .time{font-size:34px; font-weight:700}
    .sub{margin-top:6px; font-size:13px}
    .settings{display:flex; flex-direction:column; gap:10px; margin-top:12px}
    label{font-size:12px;color:var(--muted)}
    input[type=number], input[type=text], select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit}
    .toggles{display:flex; gap:8px; align-items:center}
    .history{max-height:360px; overflow:auto; margin-top:12px}
    .history-item{display:flex; justify-content:space-between; gap:8px; padding:8px; border-radius:8px; background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .footer{display:flex; justify-content:space-between; gap:10px; margin-top:12px}
    .small{font-size:12px}
    .pill{padding:6px 10px;border-radius:999px;font-size:13px}
    .accent{color:var(--accent)}
    @media (max-width:880px){ .wrap{grid-template-columns:1fr} .ring{width:180px;height:180px} }
  </style>
</head>
<body>
  <div class="wrap" id="app" data-theme="dark">
    <div class="card" aria-labelledby="title">
      <div class="header">
        <div>
          <h1 id="title" style='color:#ffbc2b;'>Pomodoro Timer</h1>
          <div class="muted">Focused sessions, automatic cycles, and persistent history</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <button id="themeBtn" title="Toggle theme">ðŸŒ—</button>
        </div>
      </div>

      <div class="timer-area" style="margin-top:14px">
        <div class="ring" role="img" aria-label="progress ring">
          <svg viewBox="0 0 120 120">
            <defs>
              <linearGradient id="g1" x1="0" x2="1"><stop offset="0%" stop-color="#ffd89b"/><stop offset="100%" stop-color="#ff7a7a"/></linearGradient>
            </defs>
            <circle cx="60" cy="60" r="48" fill="transparent" stroke="rgba(255,255,255,0.04)" stroke-width="10"></circle>
            <circle id="progress" cx="60" cy="60" r="48" fill="transparent" stroke="url(#g1)" stroke-width="10" stroke-linecap="round" stroke-dasharray="301.44" stroke-dashoffset="0" transform="rotate(-90 60 60)"></circle>
            <foreignObject x="12" y="20" width="96" height="80">
              <div xmlns="http://www.w3.org/1999/xhtml" style="display:flex;flex-direction:column;align-items:center;justify-content:center">
                <div class="time" id="timeText" style='color:#ffbc2b;'>25:00</div>
                <div class="sub muted" id="sessionLabel">Work</div>
              </div>
            </foreignObject>
          </svg>
        </div>

        <div style="flex:1">
          <div style="display:flex;flex-direction:column;gap:8px">
            <input id="taskInput" type="text" placeholder="What are you working on? (optional)" aria-label="task title" />

            <div class="controls">
              <button id="startPause" class="primary">Start</button>
              <button id="resetBtn" style='background-color:#e2a623;'>Reset</button>
              <button id="soundTest">ðŸ””</button>
            </div>

            <div class="muted small">Keyboard: Space = Start/Pause â€¢ R = Reset â€¢ T = Toggle Auto-Start</div>

            <div class="settings" id="quickSettings">
              <div style="display:flex;gap:8px">
                <label style="flex:1">Work (min)<input id="workMin" type="number" min="1" max="180" value="25"></label>
                <label style="flex:1">Short Break<input id="shortMin" type="number" min="1" max="60" value="5"></label>
                <label style="flex:1">Long Break<input id="longMin" type="number" min="5" max="60" value="15"></label>
              </div>

              <div style="display:flex;gap:8px;align-items:center">
                <label>Long after <input id="cycleCount" type="number" min="1" max="10" value="4" style="width:60px;display:inline-block;margin-left:8px"> pomodoros</label>
                <div style="flex:1"></div>
                <label class="toggles">Auto-start next <input id="autoStart" type="checkbox" checked style="margin-left:8px"></label>
              </div>

            </div>

            <div class="muted small">Session count: <span id="sessionCount">0</span> â€¢ Completed today: <span id="todayCount">0</span></div>
          </div>
        </div>
      </div>

      <div class="footer">
        <div class="muted small">Streaks & history are saved locally.</div>
        <div>
          <button id="exportBtn" style='color:#ffbc2b;'>Export</button>
        </div>
      </div>

      <div class="history" id="history"></div>
    </div>

    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <div class="muted">Controls</div>
          <div style="font-weight:700;font-style:6px;background-color:#0f1724;">Detailed Settings & Activity</div>
        </div>
        <div>
          <div class="pill" id="modePill">Mode: <span class="accent" id="modeText">Work</span></div>
        </div>
      </div>

      <div style="margin-top:14px;display:flex;flex-direction:column;gap:10px">
        <label>Sound alert<select id="soundSelect"><option value="beep">Short beep</option><option value="chime">Chime</option><option value="none">No sound</option></select></label>
        <label>Notification behavior<select id="notifSelect"><option value="toast">Desktop notification</option><option value="title">Change tab title</option><option value="mute">Mute notifications</option></select></label>
        <label>Auto focus on start <input id="focusOnStart" type="checkbox"></label>
        <label>Play gentle countdown in last 5s <input id="gentle" type="checkbox" checked></label>

        <div style="display:flex;gap:8px;align-items:center">
          <div class="muted small">Session history</div>
          <div style="flex:1"></div>
          <button id="clearHistory" style='color:#ffbc2b;'>Clear</button>
        </div>

        <div style="border-radius:8px;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)">
          <div class="muted small">How it works</div>
          <ol class="muted small">
            <li>Work session runs for the configured minutes.</li>
            <li>Short breaks happen between work sessions; after the configured cycle count you get a long break.</li>
            <li>Auto-start will begin the next session automatically if enabled.</li>
          </ol>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="muted small" >Export / import</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="importBtn" style='background-color:#0f1724;'>Import</button>
          <input id="importFile" type="file" accept="application/json" style="display:none">
        </div>
      </div>
    </div>
  </div>

  <audio id="audioBeep">
    <source src="alarm.mp3" type="audio/wav">
  </audio>

  <script>
    // Simple utility helpers
    const $ = (q,el=document)=>el.querySelector(q);
    const $$ = (q,el=document)=>Array.from(el.querySelectorAll(q));

    // Elements
    const app = $('#app');
    const startPause = $('#startPause');
    const resetBtn = $('#resetBtn');
    const workMin = $('#workMin');
    const shortMin = $('#shortMin');
    const longMin = $('#longMin');
    const cycleCount = $('#cycleCount');
    const autoStart = $('#autoStart');
    const timeText = $('#timeText');
    const sessionLabel = $('#sessionLabel');
    const progress = $('#progress');
    const modeText = $('#modeText');
    const sessionCountEl = $('#sessionCount');
    const todayCountEl = $('#todayCount');
    const taskInput = $('#taskInput');
    const historyEl = $('#history');
    const themeBtn = $('#themeBtn');
    const soundSelect = $('#soundSelect');
    const notifSelect = $('#notifSelect');
    const focusOnStart = $('#focusOnStart');
    const gentle = $('#gentle');
    const exportBtn = $('#exportBtn');
    const importBtn = $('#importBtn');
    const importFile = $('#importFile');
    const clearHistory = $('#clearHistory');
    const soundTest = $('#soundTest');

    // State and defaults
    const DEFAULTS = {work:25, short:5, long:15, cycles:4, autoStart:true};
    let state = {
      mode:'work', // work, short, long
      running:false,
      totalSec: DEFAULTS.work*60,
      remaining: DEFAULTS.work*60,
      completedPomodoros:0,
      cycleCompleted:0,
      autoStart: true
    };

    // load saved settings
    function loadSettings(){
      try{
        const s = JSON.parse(localStorage.getItem('pom_settings')||'{}');
        if(s.work) workMin.value = s.work;
        if(s.short) shortMin.value = s.short;
        if(s.long) longMin.value = s.long;
        if(s.cycles) cycleCount.value = s.cycles;
        autoStart.checked = s.autoStart ?? DEFAULTS.autoStart;
        soundSelect.value = s.sound||'beep';
        notifSelect.value = s.notif||'toast';
        focusOnStart.checked = s.focusOnStart||false;
        gentle.checked = s.gentle??true;
      }catch(e){console.warn('Load settings failed',e)}
    }
    loadSettings();

    function saveSettings(){
      localStorage.setItem('pom_settings', JSON.stringify({
        work: +workMin.value, short: +shortMin.value, long: +longMin.value, cycles: +cycleCount.value, autoStart: autoStart.checked, sound: soundSelect.value, notif: notifSelect.value, focusOnStart: focusOnStart.checked, gentle: gentle.checked
      }));
    }

    // History store
    function addHistory(entry){
      const arr = JSON.parse(localStorage.getItem('pom_history')||'[]');
      arr.unshift(entry);
      localStorage.setItem('pom_history', JSON.stringify(arr.slice(0,200)));
      renderHistory();
    }

    function getHistory(){ return JSON.parse(localStorage.getItem('pom_history')||'[]'); }
    function clearHistoryStore(){ localStorage.removeItem('pom_history'); renderHistory(); }

    function renderHistory(){
      const arr = getHistory();
      historyEl.innerHTML = arr.map(it=>`<div class="history-item"><div><div style="font-weight:600">${escapeHtml(it.task||'â€”')}</div><div class="muted small">${it.mode} â€¢ ${new Date(it.ts).toLocaleString()}</div></div><div style="text-align:right"><div>${it.durationMin}m</div></div></div>`).join('') || '<div class="muted small">No sessions yet â€” start a Pomodoro</div>';
    }

    function escapeHtml(s){ return s ? s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]) : s; }

    renderHistory();

    // Timer core
    let tickInterval = null;
    function setMode(mode){
      state.mode = mode;
      modeText.textContent = mode[0].toUpperCase()+mode.slice(1);
      sessionLabel.textContent = mode[0].toUpperCase()+mode.slice(1);
      if(mode==='work'){
        state.totalSec = +workMin.value*60;
      } else if(mode==='short'){
        state.totalSec = +shortMin.value*60;
      } else {
        state.totalSec = +longMin.value*60;
      }
      state.remaining = state.totalSec;
      updateTimeUI();
      updateProgress(0);
    }
    setMode('work');

    function updateTimeUI(){
      const m = Math.floor(state.remaining/60); const s = state.remaining%60;
      timeText.textContent = String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
      sessionCountEl.textContent = state.completedPomodoros;
      // progress
      const pct = 1 - (state.remaining / state.totalSec || 0);
      updateProgress(pct);
    }

    function updateProgress(pct){
      const r = 48; const circ = 2*Math.PI*r; const offset = Math.round((1-pct)*circ);
      progress.style.strokeDashoffset = offset;
    }

    function startTimer(){
      if(state.running) return;
      state.running = true;
      startPause.textContent = 'Pause';
      saveSettings();
      if(focusOnStart.checked) window.focus();
      tickInterval = setInterval(()=>{
        if(state.remaining>0){
          state.remaining -= 1;
          if(gentle.checked && state.remaining<=5 && state.remaining>0) { playGentle(); }
          updateTimeUI();
        } else {
          // session end
          clearInterval(tickInterval); tickInterval = null; state.running=false;
          sessionFinished();
        }
      }, 1000);
    }

    function pauseTimer(){
      if(tickInterval) clearInterval(tickInterval);
      tickInterval = null; state.running=false; startPause.textContent='Start';
    }

    function resetTimer(){
      pauseTimer(); setMode(state.mode);
    }

    function sessionFinished(){
      // record
      const durationMin = Math.round(state.totalSec/60);
      addHistory({mode: state.mode, ts: Date.now(), durationMin, task: taskInput.value});
      playAlert();
      notifyEnd(state.mode);

      if(state.mode==='work'){
        state.completedPomodoros++;
        const cycles = +cycleCount.value;
        if(state.completedPomodoros % cycles === 0){
          setMode('long');
        } else {
          setMode('short');
        }
      } else {
        setMode('work');
      }
      // update today count quick calc
      updateTodayCount();

      if(autoStart.checked){
        // slight delay to allow UI update and notification
        setTimeout(()=>startTimer(), 800);
      } else {
        startPause.textContent='Start';
      }
    }

    // Notifications and sound
    const audio = document.getElementById('audioBeep');
    function playGentle(){ try{ audio.currentTime=0; audio.play(); }catch(e){} }

    function notifyEnd(mode){
      const behavior = notifSelect.value;
      const title = mode==='work' ? 'Work session finished' : (mode==='short' ? 'Short break finished' : 'Long break finished');
      if(behavior==='toast'){
        if(Notification.permission==='granted'){
          new Notification(title, {body:'Click to continue', silent: true});
        } else if(Notification.permission!=='denied'){
          Notification.requestPermission().then(p=>{ if(p==='granted') new Notification(title, {silent:true}); });
        }
      } else if(behavior==='title'){
        const orig = document.title; document.title = title; setTimeout(()=>document.title = orig,4000);
      }
    }

    // Helpers
    function toggleStartPause(){ if(state.running) pauseTimer(); else startTimer(); }

    // Buttons
    startPause.addEventListener('click', ()=>{ toggleStartPause(); });
    resetBtn.addEventListener('click', ()=>{ resetTimer(); });
    themeBtn.addEventListener('click', ()=>{ const cur = app.getAttribute('data-theme'); app.setAttribute('data-theme', cur==='dark'?'light':'dark'); });
    soundTest.addEventListener('click', ()=>{ playAlert(); });

    // inputs save
    [workMin, shortMin, longMin, cycleCount, autoStart, soundSelect, notifSelect, focusOnStart, gentle].forEach(el=>el.addEventListener('change', ()=>{ saveSettings(); setMode(state.mode); }));

    // keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if(e.code==='Space'){ e.preventDefault(); toggleStartPause(); }
      if(e.key==='r' || e.key==='R'){ resetBtn.click(); }
      if(e.key==='t' || e.key==='T'){ autoStart.checked = !autoStart.checked; saveSettings(); }
    });

    // export / import
    exportBtn.addEventListener('click', ()=>{
      const data = {settings: JSON.parse(localStorage.getItem('pom_settings')||'{}'), history: getHistory()};
      const blob = new Blob([JSON.stringify(data, null, 2)],{type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='pomodoro-export.json'; a.click(); URL.revokeObjectURL(url);
    });
    importBtn.addEventListener('click', ()=>importFile.click());
    importFile.addEventListener('change', async (ev)=>{
      const f = ev.target.files[0]; if(!f) return; const txt = await f.text(); try{ const j = JSON.parse(txt); if(j.settings) localStorage.setItem('pom_settings', JSON.stringify(j.settings)); if(j.history) localStorage.setItem('pom_history', JSON.stringify(j.history)); loadSettings(); renderHistory(); alert('Imported'); }catch(e){alert('Invalid file')}
    });

    clearHistory.addEventListener('click', ()=>{ if(confirm('Clear all history?')){ clearHistoryStore(); }});

    // utility to update today's count
    function updateTodayCount(){
      const arr = getHistory(); const today = new Date(); const start = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
      const todays = arr.filter(i=>i.ts>=start && i.mode==='work');
      todayCountEl.textContent = todays.length;
    }
    updateTodayCount();

    // render history initially and periodically
    renderHistory();

    // small visual progress stroke setup
    (function(){ const r=48; const circ = 2*Math.PI*r; progress.style.strokeDasharray = circ; progress.style.strokeDashoffset = circ; })();

    // On load, restore settings
    (function(){
      // try to request notification permission so first alert works smoothly
      if('Notification' in window && Notification.permission === 'default'){
        // do not force request; defer until user interacts
      }
      // show saved session count
      try{ const s = JSON.parse(localStorage.getItem('pom_state')||'{}'); if(s.completedPomodoros) state.completedPomodoros = s.completedPomodoros; }catch(e){}
      updateTimeUI();
    })();

    // persist some state periodically
    setInterval(()=>{ localStorage.setItem('pom_state', JSON.stringify({completedPomodoros: state.completedPomodoros})); }, 5000);

    // small helper to play a short beep using WebAudio when audio element is limited
    function simpleBeep(){ try{ const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.type='sine'; o.frequency.value=880; g.gain.value=0.05; o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>{ o.stop(); ctx.close(); },120); }catch(e){} }

    // fallback: if audio can't play, use WebAudio beep
    function playAlert(){
      const s = soundSelect.value; if(s==='none') return;
      const canPlay = !!audio && audio.play;
      if(canPlay){ try{ audio.currentTime=0; audio.play().catch(()=>simpleBeep()); }catch(e){ simpleBeep(); } }
      else simpleBeep();
    }

    // Keep UI updated when page becomes visible
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible'){ updateTimeUI(); }});

  </script>
</body>
</html>
